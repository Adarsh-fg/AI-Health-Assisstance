{% extends "base.html" %}

{% block title %}Personal Health Review{% endblock %}

{% block content %}
<div class="card">
    <div class="page-header">
        <h2 class="page-title"><i class="fas fa-user-md"></i> Personal Health Review</h2>
        <!-- Dashboard Button stays here -->
        <div class="action-buttons">
            <a href="{{ url_for('dashboard') }}" class="btn"><i class="fas fa-th-large"></i> View Visual Dashboard</a>
        </div>
    </div>
    <p>Based on your complete profile, here's an AI-generated analysis of your health. Remember, this is for informational purposes and not a substitute for professional medical advice.</p>
    
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ 'success' if category == 'success' else 'error' }}" style="margin-top: 1rem;">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    {% if not user.weight or not user.height %}
        <div class="alert alert-warning" style="margin-top: 2rem;">
            <i class="fas fa-exclamation-triangle"></i>
            Please <a href="{{ url_for('settings') }}">update your weight and height</a> in the settings to get a full health review, including your BMI.
        </div>
    {% else %}
        <div class="user-details-summary" style="margin-top: 2rem;">
            <div class="profile-section">
                <h4><i class="fas fa-user-circle"></i> Your Profile</h4>
                <ul>
                    <li><strong>Age:</strong> {{ user.age }}</li>
                    <li><strong>Gender:</strong> {{ user.gender.capitalize() }}</li>
                    <li><strong>Weight:</strong> {{ user.weight }} kg</li>
                    <li><strong>Height:</strong> {{ user.height }} cm</li>
                    <li><strong>BMI:</strong> {{ "%.1f"|format(bmi) }} ({{ bmi_category }})</li>
                </ul>
            </div>
            <div class="profile-section">
                <h4><i class="fas fa-notes-medical"></i> Health History</h4>
                <ul>
                    <li><strong>Blood Group:</strong> {{ user.blood_group or 'Not set' }}</li>
                    <li><strong>Chronic Illnesses:</strong> {{ user.chronic_illnesses or 'None listed' }}</li>
                    <li><strong>Past Surgeries:</strong> {{ user.past_surgeries or 'None listed' }}</li>
                    <li><strong>Family Genetic Diseases:</strong> {{ user.genetic_diseases or 'None listed' }}</li>
                    <li><strong>Last Check-up:</strong> {{ user.last_checkup_date or 'Not set' }}</li>
                </ul>
            </div>
             <div class="profile-section">
                <h4><i class="fas fa-pills"></i> Current Medications</h4>
                {% if medications %}
                    <ul>
                    {% for med in medications %}
                        <li>{{ med.name }} ({{ med.dosage }})</li>
                    {% endfor %}
                    </ul>
                {% else %}
                    <p>No medications listed.</p>
                {% endif %}
            </div>
            <div class="profile-section">
                <h4><i class="fas fa-calendar-check"></i> Upcoming Appointments</h4>
                {% if appointments %}
                     <ul>
                    {% for app in appointments %}
                        <li>Dr. {{ app.doctor_name }} ({{ app.specialty }}) on {{ app.date }}</li>
                    {% endfor %}
                    </ul>
                {% else %}
                    <p>No upcoming appointments.</p>
                {% endif %}
            </div>
        </div>

        <!-- Generate Analysis Button back to its original spot -->
        <form method="POST" action="{{ url_for('health_review') }}" style="margin-top: 2rem;">
            <button type="submit" class="btn"><i class="fas fa-robot"></i> Generate New AI Health Analysis</button>
        </form>

    {% endif %}
</div>

{% if result %}
<div class="card" style="margin-top: 2rem;">
    <h3><i class="fas fa-brain"></i> AI Health Analysis</h3>
    <div class="gemini-result">
        {{ result | safe }}
    </div>
</div>
{% endif %}

<style>
.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap; /* Allows buttons to wrap on smaller screens */
    gap: 1rem;
    margin-bottom: 1rem;
}
.page-header .page-title {
    margin-bottom: 0; /* Override default margin */
}
.action-buttons {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.user-details-summary { 
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    background-color: var(--background-color); 
    padding: 1.5rem; 
    border-radius: 12px; 
    border: 1px solid var(--border-color);
}
.profile-section h4 { color: var(--primary-color); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;}
.profile-section ul { list-style: none; padding-left: 0.5rem; }
.profile-section li { margin-bottom: 0.5rem; }

.gemini-result { line-height: 1.7; }
.gemini-result h4 { color: var(--primary-color); margin-top: 1.5rem; margin-bottom: 0.75rem; border-bottom: 2px solid var(--border-color); padding-bottom: 0.5rem;}
.gemini-result ul { list-style-type: 'âœ“'; padding-left: 2rem; }
.gemini-result li { margin-bottom: 0.5rem; }

@media (max-width: 768px) {
    .user-details-summary {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}